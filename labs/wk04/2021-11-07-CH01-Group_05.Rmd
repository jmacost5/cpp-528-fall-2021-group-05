---
title: "This is an example page"
subtitle: "The title above can be anything you want. However, the file name must be in this specific format: `YYYY-MM-DD-chXX-short_name.md`."
author: "Cristian E. Nuno"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  rmdformats::downcute:
    self_contained: true
    thumbnails: true
    lightbox: true
    gallery: false
    highlight: tango
    df_print: paged
  md_document:
    variant: gfm
---

```{r}
#professional growth
#percent vacant homes
#per capita income/household income
```





```{r setup, include=FALSE}
# define chunk options
knitr::opts_chunk$set(echo = TRUE, 
                      message = FALSE, 
                      warning = FALSE, 
                      eval = TRUE, 
                      fig.width=10)

# load necessary functions
source(here::here("analysis/utilities.R"))
```


```{r include=FALSE}
#Load the necessary packages ----
library(dplyr)
library(here)
library(knitr)
library(pander)
library(stargazer)
library(scales)

#set randomization seed ---
set.seed(1234)

#Load necessary functions and objects ---
#note:  all of these are R objects that will be used throughout this .rmd file
import::here("S_TYPE",
             "panel.cor",
             "cbsa_stats_df",
             "panel.smooth",
             "jplot",
             "d",
             "df",
             .from = here::here("labs/lab_04_source.R"),
             .character_only = TRUE)
```


Today's date is `r today()`.


## Data Information

* Data includes only specified owner-occupied housing units-one-family houses on less than 10 acres without a business or medical office on the property.
* Excludes mobile homes, houses with a business or medical office, houses on 10 or more acres, and housing units in multi-unit structures.
*Owner-Occupied is defined as a housing unit with the owner or co-owner living in the unit, even if it is morgaged or not fully paid for.  The owner or co-owner must live in the unit and usually is Person 1 on the questionnaire.  
* All cases from the data with a Median Home Value less than $10,000 in 2000 and high home values in 2010 have been dropped.  


```{r}
d1 <- readRDS(here::here("data/rodeo/LTDB-2010.rds"))
d2 <- readRDS(here::here("data/rodeo/LTDB-2000.rds"))
md <- readRDS(here::here("data/rodeo/LTDB-META-DATA.rds"))

d1 <- dplyr::select( d1, - year )
d2 <- dplyr::select( d2, - year )

d <- merge( d1, d2, by="tractid" )
d <- merge( d, md, by="tractid" )

# filter rural districts
d <- dplyr::filter( d, urban == "urban" )

d <- dplyr::select( d, tractid, 
             mhmval00, mhmval12, 
             hinc00, 
             hu00, vac00, own00, rent00, h30old00,
             empclf00, clf00, unemp00, prof00,  
             dpov00, npov00,
             ag25up00, hs00, col00, 
             pop00.x, nhwht00, nhblk00, hisp00, asian00, empclf12,vac12, hinc12,hu12,
             cbsa, prof12, cbsaname )


d <- 
  d %>%
  dplyr::mutate( p.white = 100 * nhwht00 / pop00.x,
          p.black = 100 * nhblk00 / pop00.x,
          p.hisp = 100 * hisp00 / pop00.x, 
          p.asian = 100 * asian00 / pop00.x,
          p.hs = 100 * (hs00+col00) / ag25up00,
          p.col = 100 * col00 / ag25up00,
          p.prof00 = 100 * prof00 / empclf00,
          p.prof10 = 100 * prof12/empclf12,
          p.unemp = 100 * unemp00 / clf00,
          p.vacant = 100 * vac00 / hu00,
          p.vacant10 = 100 * vac12/hu12,
          mhv.change.00.to.10 = mhmval12 - mhmval00,
          p.mhv.change = 100 * (mhmval12 - mhmval00) / mhmval00,
          pov.rate = 100 * npov00 / dpov00 )


# inflation rate
INFLATION_RATE <- 1.28855 

# adjust 2000 home values for inflation 
mhv.00 <- d$mhmval00 * INFLATION_RATE 
mhv.10 <- d$mhmval12

# change in MHV in dollars
mhv.change <- mhv.10 - mhv.00


# drop low 2000 median home values
# to avoid unrealistic growth rates.
#
# tracts with homes that cost less than
# $10,000 are outliers
mhv.00[ mhv.00 < 10000 ] <- NA

# change in MHV in percent
mhv.growth <- 100 * ( mhv.change / mhv.00 )

d$mhv.00 <- mhv.00
d$mhv.10 <- mhv.10
d$mhv.change <- mhv.change
d$mhv.growth <- mhv.growth 

# change in professional employees

pprof.00 <- d$p.prof00
pprof.10 <- d$p.prof10
pprof.change <- pprof.10 - pprof.00
pct.pprof.change <- (pprof.change/pprof.00)
d$pprof.change <- pprof.change
d$pprof.growth <- pct.pprof.change


#Change in Vacancy 
vacant.00 <- d$p.vacant
vacant.10 <- d$p.vacant10
vacant.change <- vacant.10 - vacant.00
pct.vacant.change <- (vacant.change/vacant.00)
d$vacant.growth <- pct.vacant.change


```

# create mini data frame
```{r}
df <- data.frame( MedianHomeValue2000=mhv.00, 
                  MedianHomeValue2010=mhv.10, 
                  MHV.Change.00.to.10=mhv.change,
                  MHV.Growth.00.to.12=mhv.growth)
                  
```



## Median Home Value


```{r}
hist( df$MedianHomeValue2000, breaks=200, xlim=c(0,500000), 
      col="gray20", border="white",
      axes=F, 
      xlab="MHV (median = $138k)",
      ylab="",
      main="Median Home Value in 2000 (2010 US dollars)" )
axis( side=1, at=seq(0,500000,100000), 
      labels=c("$0","$100k","$200k","$300k","$400k","$500k") )
abline( v=median( df$MedianHomeValue2000, na.rm=T ), col="orange", lwd=3 )
```



### Descriptives

```{r}
stargazer( df, 
           type="text", #S_TYPE, 
           digits=0, 
           summary.stat = c("min", "p25","median","mean","p75","max") )
```

### Change in MHV 2000 - 2010

```{r}
hist( df$MHV.Change.00.to.10/1000, breaks=500, 
      xlim=c(-100,500), yaxt="n", xaxt="n",
      xlab="Thousand of US Dollars (adjusted to 2010)", cex.lab=1.5,
      ylab="", main="Change in Median Home Value 2000 to 2010",
      col="gray20", border="white" )
axis( side=1, at=seq( from=-100, to=500, by=100 ), 
      labels=paste0( "$", seq( from=-100, to=500, by=100 ), "k" ) )
        
mean.x <- mean( df$MHV.Change.00.to.10/1000, na.rm=T )
abline( v=mean.x, col="darkorange", lwd=2, lty=2 )
text( x=200, y=1500, 
      labels=paste0( "Mean = ", dollar( round(1000*mean.x,0)) ), 
      col="darkorange", cex=1.8, pos=3 )
median.x <- median( df$MHV.Change.00.to.10/1000, na.rm=T )
abline( v=median.x, col="dodgerblue", lwd=2, lty=2 )
text( x=200, y=2000, 
      labels=paste0( "Median = ", dollar( round(1000*median.x,0)) ), 
      col="dodgerblue", cex=1.8, pos=3 )
```


```{r}

```


### Percent Change in Median Home Value 2000 to 2010

```{r}
hg <-
hist( df$MHV.Growth.00.to.12, breaks=5000, 
      xlim=c(-100,200), yaxt="n", xaxt="n",
      xlab="", cex.main=1.5,
      ylab="", main="Growth in Home Value by Census Tract 2000 to 2010",
      col="gray40", border="white" )
axis( side=1, at=seq( from=-100, to=200, by=50 ), 
      labels=paste0( seq( from=-100, to=200, by=50 ), "%" ) )
ymax <- max( hg$count )
        
mean.x <- mean( df$MHV.Growth.00.to.12, na.rm=T )
abline( v=mean.x, col="darkorange", lwd=2, lty=2 )
text( x=100, y=(0.5*ymax), 
      labels=paste0( "Mean = ", round(mean.x,0), "%"), 
      col="darkorange", cex=1.8, pos=4 )
median.x <- median( df$MHV.Growth.00.to.12, na.rm=T )
abline( v=median.x, col="dodgerblue", lwd=2, lty=2 )
text( x=100, y=(0.6*ymax), 
      labels=paste0( "Median = ", round(median.x,0), "%"), 
      col="dodgerblue", cex=1.8, pos=4 )
```

## Metro Level Statistics

```{r}

```

```{r}
cbsa_stats_df %>% head()
```



## Modeling
```{r}

```


### Choosing Variables



#### Metro Demographics

**Professional Employee**
```{r}
par( mfrow=c(2,2) )
hist( d$p.prof00, breaks=150, col="gray20", border="white", 
      yaxt="n", xlab="xlabel", ylab="", main="Percent of Professional Employees 2000",)
hist( log(d$p.prof00+1), breaks=150, col="gray20", border="white",
      yaxt="n", xlab="", ylab="", main="Percent of Professional Employees 2000 (logged)")
hist( d$p.prof10, breaks=150, col="gray20", border="white", 
      yaxt="n", xlab="xlabel", ylab="", main="Percent of Professional Employees 2010",)
hist( log(d$p.prof10+1), breaks=150, col="gray20", border="white",
      yaxt="n", xlab="", ylab="", main="Percent of Professional Employees 2010 (logged)")
```

```{r}
par( mfrow=c(1,2) )
hist( d$pprof.growth, breaks= 50, col="gray20", border="white", xlim=c(-10,25),
      yaxt="n", xlab="xlabel", ylab="", main="Percent of Professional Employees Change 2000 to 2010",)
hist( log(d$pprof.growth + 1), breaks=50, col="gray20", border="white",xlim=c(-3,5),
      yaxt="n", xlab="", ylab="", main="Percent of Professional Employees Change 2000 to 2010(logged)")
```








**Vacancy Rate**

```{r}
par( mfrow=c(2,2) )
hist( d$p.vacant, breaks=50, col="gray20", border="white",
      yaxt="n", xlab="", ylab="", main="Percent Vacant 2000")
hist( log(d$p.vacant+1), breaks=50, col="gray20", border="white",
      yaxt="n", xlab="", ylab="", main="Percent Vacant 2000 (logged)")
hist( d$p.vacant10, breaks=50, col="gray20", border="white",
      yaxt="n", xlab="", ylab="", main="Percent Vacant 2010")
hist( log(d$p.vacant10+1), breaks=50, col="gray20", border="white",
      yaxt="n", xlab="", ylab="", main="Percent Vacant 2010 (logged)")
```

```{r}
par( mfrow=c(1,2) )
hist( d$vacant.growth, breaks=50, col="gray20", border="white",
      yaxt="n", xlab="", ylab="", main="Percent Vacant Change 2000 to 2010")
hist( log(d$vacant.growth+1), breaks=50, col="gray20", border="white",
      yaxt="n", xlab="", ylab="", main="Percent Vacant Change 2000 to 2010 (logged)")
```






**Professional Employee and Vacant Rate**

```{r}
log.p.vacant <- log10( d$p.vacant + 1 )
log.profempl <- log10( d$p.prof00 + 1 )
these <- sample( 1:length(log.profempl), 5000 )
par( mfrow=c(1,2) )
jplot( d$p.prof00[these], d$p.vacant[these], 
       lab1="Professional Employee", lab2="Vacant Homes (percent)",
       main="Raw Measures" )
jplot( log.profempl[these], log.p.vacant[these], 
       lab1="Professional Employee", lab2="Vacant Homes (percent)",
       main="Log Transformed" )
```


**Correlation Vacancy Rate and Poverty Rate**

```{r}
cor( d$p.vacant, d$p.prof00, use="pairwise.complete" )
cor( log.p.vacant, log.profempl, use="pairwise.complete" )
```


## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}

#create subset to visualize in correlatin matrix

d2 <- select(d, mhv.growth, p.vacant, d$p.prof.00) #pov.rate, p.unemp)

#reduce data density for visualizaiton

set.seed(1234)

d3 <- sample_n(d2, 10000) %>% na.omit()

#correlation plots

pairs(d3, upper.panel = panel.cor, lower.panel = panel.smooth)

```

**Log transformations**


```{r logtransformation, echo=FALSE}
set.seed( 1234 )
d2 <- select( d, mhv.growth, p.vacant, p.prof,  pov.rate, p.unemp )
# recode some vars to remove outliers and skew
d2$mhv.growth[ d2$mhv.growth > 200 ] <- NA
d2$p.unemp <- log10( d2$p.unemp + 1 )
d2$p.vacant <- log10( d2$p.vacant + 1 )
d2$p.prof <- log10( d2$p.prof + 1  )
d2$pov.rate <- log10( d2$pov.rate + 1 )
d4 <- sample_n( d2, 5000 ) %>% na.omit()
pairs( d4, upper.panel=panel.cor, lower.panel=panel.smooth )
```


**Correlation between MHV and Vacancy Rates**

```{r}
jplot( d3$p.vacant, d3$mhv.growth, ylim=c(-50,100),
       lab1="Vacancy Rates", lab2="MHV Growth" )
```




## Including regression output

```{r regression, results='asis'}
# load necessary packages ----
library(stargazer)

# load constants ----
STARGAZER_OUTPUT_TYPE = "html"

# create model ----
reg.data <- d
reg.data$mhv.growth[ reg.data$mhv.growth > 200 ] <- NA
reg.data$p.unemp <- log10( reg.data$p.unemp + 1 )
reg.data$p.vacant <- log10( reg.data$p.vacant + 1 )
reg.data$pov.rate <- log10( reg.data$pov.rate + 1 )
m1 <- lm( mhv.growth ~  pov.rate, data=reg.data )
m2 <- lm( mhv.growth ~  p.unemp, data=reg.data )
m3 <- lm( mhv.growth ~  pov.rate + p.unemp, data=reg.data )

# display model
stargazer( m1, m2, m3, 
           type="text", #S_TYPE,
           digits=2,
           omit.stat = c("rsq","f") )
```


## Group Structure

```{r}
d5 <- filter( d, cbsaname %in% 
                c("Tyler, TX",
                  "Minneapolis-St. Paul-Bloomington, MN-WI",
                  "San Francisco-San Mateo-Redwood City,CA") )
d5$cbsaname <- factor( d5$cbsaname, labels=c("MSP-MN","SF-CA","Tyler-TX") )
par( mar=c(4,6,4,6), mfrow=c(1,2) )
plot( d5$cbsaname,  d5$mhv.00, las=1, frame.plot=F, outline=F,
      xlab="", ylab="", main="Home Values in 2000" )
abline( h=seq(0,1200000,100000), lty=3, col=gray(0.5,0.3) )
axis( side=4, las=1 )
plot( d5$cbsaname,  d5$p.unemp, las=1, frame.plot=F, outline=F,
      xlab="", ylab="", main="Unemployment Rates in 2000" )
abline( h=seq(0,15,1), lty=3, col=gray(0.5,0.3) )
axis( side=4, las=1 )
```

**Health of City 2000 to 2010 Grouped**

```{r}
d5 <- filter( d, cbsaname %in%
                c("Tyler, TX",
                  "Youngstown-Warren-Boardman, OH-PA",
                  "Syracuse, NY") )
d5$mhv.growth[ d5$mhv.growth > 200 ] <- NA
d5$p.unemp <- log10( d5$p.unemp + 1 )
x <- rnorm( nrow(d5), 0, 0.1 ) +
     as.numeric( d5$cbsaname == "Tyler, TX" ) + 
     2 * as.numeric( d5$cbsaname == "Youngstown-Warren-Boardman, OH-PA" ) + 
     3* as.numeric( d5$cbsaname == "Syracuse, NY" ) 
par( mfrow=c(1,2) )
plot( x, d5$mhv.growth, 
      pch=19, cex=1.5, bty = "n",  
        col=factor(d5$cbsa),
      ylim=c(-50,50),
      xaxt="n", 
      ylab="", xlab="",
      main="MHV Growth")
axis( side=1, at=1:3, labels=c("Tyler","Youngstown","Syracuse"), 
      tick=F, col.axis="gray60", cex.axis=1.3 )
plot( x, d5$p.unemp, 
      pch=19, cex=1.5, bty = "n",  
        col=factor(d5$cbsa),
      # ylim=c(0,40),
      xaxt="n", 
      ylab="", xlab="",
      main="Unemployment (logged)")
axis( side=1, at=1:3, labels=c("Tyler","Youngstown","Syracuse"), 
      tick=F, col.axis="gray60", cex.axis=1.3 )
```

**Baseline metro-levle home value growth**

```{r}
m <- lm( mhv.growth ~ factor(cbsaname) + p.unemp - 1, data=d5 )
b0.syracuse   <- m$coefficients[1] 
b0.tyler      <- m$coefficients[2] 
b0.youngston  <- m$coefficients[3] 
b1            <- m$coefficients[4] 
palette( c( "steelblue", "green3", "darkorange"  ) )
palette( adjustcolor( palette(), alpha.f = 0.3 ) )
plot( d5$p.unemp, d5$mhv.growth,
        pch=19, cex=1.5, bty = "n",  
        col=factor(d5$cbsa),
      ylim=c(-50,50),
      xlab="Unemployment Rate (logged)",
      ylab="Median Home Value Growth 2000-2010")
          
abline( b0.syracuse, b1, col="steelblue", lwd=3 )
abline( b0.tyler, b1, col="green3", lwd=3 )
abline( b0.youngston, b1, col="darkorange", lwd=3 )
```

**Adding fixed effect**

```{r}
d.reg <- d
d.reg$mhv.growth[ d.reg$mhv.growth > 200 ] <- NA
d.reg$p.unemp <- log10( d.reg$p.unemp + 1 )
# average growth in median home value for the city
d.reg <- 
  d.reg %>%
  group_by( cbsaname ) %>%
  mutate( metro.mhv.growth = 100 * median( mhv.growth, na.rm=T ) ) %>%
  ungroup() 
m1 <- lm( mhv.growth ~ p.unemp, data=d.reg )
m2 <- lm( mhv.growth ~ p.unemp + metro.mhv.growth, data=d.reg )
m3 <- lm( mhv.growth ~ p.unemp + cbsa, data=d.reg )
stargazer( m1, m2, m3, 
           type="text", #S_TYPE,
           digits=2,
           omit.stat = c("rsq","f"),
           omit="cbsa",
           add.lines = list(c("Metro Fixed Effects:", "NO", "NO","YES")) )
```

